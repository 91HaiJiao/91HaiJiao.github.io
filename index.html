<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>保卫光之国 - 水晶战线-WWZ</title>
    <style>
        :root {
            --hud-bg: rgba(10, 25, 35, 0.85);
            --hud-border: #00e5ff;
            --hud-glow: 0 0 10px rgba(0, 229, 255, 0.5);
            --text-main: #ffffff;
            --text-accent: #ffd700;
        }

        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: #050b14;
            overflow: hidden;
            position: fixed;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-wrapper {
            position: relative;
            width: 100%; height: 100%;
            max-width: 1200px;
            aspect-ratio: 16/9;
            background: #000;
            box-shadow: 0 0 50px rgba(0, 229, 255, 0.2);
            border: 1px solid #333;
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; touch-action: none; }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 11, 20, 0.9);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border: 2px solid var(--hud-border);
        }

        .title-box {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid var(--hud-border);
            padding-bottom: 20px;
            box-shadow: 0 10px 30px -10px rgba(0, 229, 255, 0.3);
        }

        h1 {
            font-size: 4rem; margin: 0;
            color: #fff;
            text-shadow: 0 0 20px #00e5ff, 0 0 40px #00e5ff;
            font-style: italic;
            letter-spacing: 4px;
        }
        
        .subtitle { color: var(--text-accent); font-size: 1.4rem; letter-spacing: 2px; margin-top: 10px; }

        .btn-start {
            padding: 15px 50px;
            font-size: 1.6rem;
            color: #000;
            background: var(--hud-border);
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.6);
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .btn-start:hover {
            background: #fff;
            box-shadow: 0 0 40px rgba(0, 229, 255, 1);
            transform: scale(1.05);
        }

        #ui-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 15%;
            background: linear-gradient(180deg, rgba(0,20,30,0.95) 0%, rgba(0,20,30,0.6) 100%);
            border-bottom: 1px solid var(--hud-border);
            display: flex; align-items: center;
            padding: 0 20px; box-sizing: border-box;
            z-index: 10;
        }

        .energy-display {
            display: flex; align-items: center;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--hud-border);
            padding: 8px 20px;
            border-radius: 4px;
            margin-right: 20px;
            box-shadow: var(--hud-glow);
        }
        .icon-spark {
            width: 25px; height: 25px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 15px #ffd700;
            margin-right: 10px;
        }
        #energy-num { font-size: 1.5rem; font-weight: bold; color: #fff; text-shadow: 0 0 5px #00e5ff; }

        .card-slot {
            display: flex; gap: 8px; flex-grow: 1; height: 90%; align-items: center;
            justify-content: center;
        }

        .card {
            width: 12%; height: 85%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .card:hover { background: rgba(0, 229, 255, 0.1); border-color: #fff; }
        .card.selected { 
            border: 2px solid #ffd700; 
            background: rgba(255, 215, 0, 0.15); 
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); 
            transform: translateY(-2px);
        }
        .card.disabled { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }

        .c-icon { width: 45%; height: 45%; border-radius: 50%; margin-bottom: 5px; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .c-name { font-size: 0.7rem; color: #aaa; margin-bottom: 2px; }
        .c-cost { font-size: 0.9rem; color: #00e5ff; font-weight: bold; text-shadow: 0 0 5px rgba(0,229,255,0.5); }

        #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 0, 0, 0.9);
            display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }
        #game-over h2 { color: #ff3d00; font-size: 3rem; text-shadow: 0 0 30px red; }
        .btn-retry {
            padding: 10px 40px; font-size: 1.2rem;
            background: #ff3d00; color: #fff; border: none;
            cursor: pointer; border-radius: 4px;
            box-shadow: 0 0 20px rgba(255, 61, 0, 0.4);
        }

        @media (max-aspect-ratio: 16/9) { #game-wrapper { width: 100%; height: auto; aspect-ratio: 16/9; } }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="start-screen">
        <div class="title-box">
            <h1>ULTRA DEFENSE</h1>
            <div class="subtitle">光之国：水晶战线</div>
            <div class="subtitle">WU WANG ZE--泽哥版</div>
        </div>
        <button class="btn-start" onclick="startGame()">启动防御系统</button>
    </div>

    <div id="ui-bar" style="display:none;">
        <div class="energy-display">
            <div class="icon-spark"></div>
            <span id="energy-num">300</span>
        </div>
        <div class="card-slot">
            <div class="card" id="c-mother" onclick="game.select('mother')">
                <div class="c-icon" style="background: radial-gradient(#ef9a9a, #c62828);"></div>
                <div class="c-name">奥特之母</div>
                <div class="c-cost">50</div>
            </div>
            <div class="card" id="c-man" onclick="game.select('man')">
                <div class="c-icon" style="background: radial-gradient(#cfd8dc, #546e7a);"></div>
                <div class="c-name">初代</div>
                <div class="c-cost">100</div>
            </div>
            <div class="card" id="c-seven" onclick="game.select('seven')">
                <div class="c-icon" style="background: radial-gradient(#ffccbc, #bf360c);"></div>
                <div class="c-name">赛文</div>
                <div class="c-cost">125</div>
            </div>
            <div class="card" id="c-tiga" onclick="game.select('tiga')">
                <div class="c-icon" style="background: radial-gradient(#e1bee7, #7b1fa2);"></div>
                <div class="c-name">迪迦</div>
                <div class="c-cost">175</div>
            </div>
            <div class="card" id="c-taro" onclick="game.select('taro')">
                <div class="c-icon" style="background: radial-gradient(#ffab91, #d84315);"></div>
                <div class="c-name">泰罗</div>
                <div class="c-cost">200</div>
            </div>
            <div class="card" id="c-ace" onclick="game.select('ace')">
                <div class="c-icon" style="background: radial-gradient(#fff59d, #fbc02d);"></div>
                <div class="c-name">艾斯</div>
                <div class="c-cost">150</div>
            </div>
        </div>
    </div>

    <div id="game-over">
        <h2>防线崩溃 !</h2>
        <button class="btn-retry" onclick="location.reload()">重启时间线</button>
    </div>
</div>

<script>
const CFG = {
    GW: 90, GH: 100, 
    OX: 40, OY: 100, 
    COLS: 9, ROWS: 5,
    W: 900, H: 600
};

const Draw = {
    hp: (ctx, x, y, hp, max, w) => {
        if (hp >= max) return;
        const p = Math.max(0, hp / max);
        const c = p > 0.5 ? '#00e676' : (p > 0.2 ? '#ffea00' : '#ff1744');
        
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fillRect(x, y - 12, w, 6);
        ctx.fillStyle = c;
        ctx.shadowBlur = 5; ctx.shadowColor = c; 
        ctx.fillRect(x + 1, y - 11, (w - 2) * p, 4);
        ctx.shadowBlur = 0;
    },

    ultra: (ctx, x, y, bodyColor, timerColor) => {
        ctx.save();
        ctx.translate(x, y);
        ctx.shadowBlur = 15; ctx.shadowColor = bodyColor;
        
        ctx.fillStyle = '#f5f5f5';
        ctx.beginPath(); ctx.ellipse(0, 0, 18, 24, 0, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = bodyColor;
        ctx.beginPath(); ctx.moveTo(-12, 25); ctx.lineTo(12, 25); ctx.lineTo(0, 55); ctx.fill();
        
        ctx.shadowBlur = 10; ctx.shadowColor = '#ffff00';
        ctx.fillStyle = '#ffff00'; 
        ctx.beginPath(); ctx.ellipse(-8, -2, 6, 9, -0.2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(8, -2, 6, 9, 0.2, 0, Math.PI*2); ctx.fill();
        
        if(timerColor) {
            ctx.shadowBlur = 8; ctx.shadowColor = timerColor;
            ctx.fillStyle = timerColor;
            ctx.beginPath(); ctx.arc(0, 35, 4, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(-1, 33, 1.5, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
    },

    kaiju: (ctx, x, y, color, type) => {
        ctx.save();
        ctx.translate(x, y);
        ctx.fillStyle = color;
        ctx.shadowBlur = 0; 
        
        ctx.fillRect(-18, -25, 36, 65);
        ctx.beginPath(); ctx.arc(0, -30, 22, 0, Math.PI*2); ctx.fill();
        
        ctx.shadowBlur = 5; ctx.shadowColor = 'red';
        ctx.fillStyle = '#ff3d00';
        ctx.beginPath(); ctx.arc(-8, -30, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(8, -30, 4, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        
        if (type === 'cone') {
            ctx.fillStyle = '#ff9800'; 
            ctx.beginPath(); ctx.moveTo(-16, -45); ctx.lineTo(16, -45); ctx.lineTo(0, -75); ctx.fill();
        } else if (type === 'bucket') {
            ctx.fillStyle = '#b0bec5'; 
            ctx.fillRect(-16, -65, 32, 30);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.strokeRect(-16, -65, 32, 30);
        }
        ctx.restore();
    }
};

class Obj { constructor(x,y){this.x=x;this.y=y;this.del=false;} }

class Spark extends Obj {
    constructor(x, y, ty) { super(x, y); this.ty=ty; this.val=25; this.a=0; }
    update() { if(this.y<this.ty) this.y+=3; this.a+=0.05; }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x+25, this.y+25); ctx.rotate(this.a);
        const g = ctx.createRadialGradient(0,0,2,0,0,25);
        g.addColorStop(0, '#fff'); g.addColorStop(0.4, '#ffd700'); g.addColorStop(1, 'rgba(255,215,0,0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(0,0,30,0,Math.PI*2); ctx.fill();
        ctx.restore();
    }
}

class Shot extends Obj {
    constructor(x, y, type) {
        super(x, y); this.type=type; this.vx=12; this.dmg=25;
        if(type==='seven') { this.dmg=35; this.vx=14; }
        if(type==='ace') { this.dmg=55; this.vx=10; }
    }
    update() { this.x+=this.vx; if(this.x>CFG.W) this.del=true; }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y);
        if(this.type==='ice') {
            ctx.shadowBlur=10; ctx.shadowColor='#00e5ff';
            ctx.fillStyle='#00e5ff'; ctx.fillRect(0, -3, 30, 6);
            ctx.fillStyle='#fff'; ctx.fillRect(0, -1, 30, 2);
        } else if(this.type==='seven') {
            ctx.rotate(game.frame*0.6);
            ctx.fillStyle='#ff3d00';
            ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#fff';
            ctx.beginPath(); ctx.moveTo(-4,-4); ctx.lineTo(14,0); ctx.lineTo(-4,4); ctx.fill();
        } else if(this.type==='ace') {
            ctx.rotate(game.frame*0.3);
            ctx.shadowBlur=10; ctx.shadowColor='#ffd700';
            ctx.strokeStyle='#ffd700'; ctx.lineWidth=3;
            ctx.strokeRect(-10,-10,20,20);
        } else {
            ctx.shadowBlur=8; ctx.shadowColor='#2979ff';
            ctx.fillStyle='#2979ff';
            ctx.beginPath(); ctx.ellipse(0,0,18,5,0,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#fff';
            ctx.beginPath(); ctx.ellipse(0,0,12,2,0,0,Math.PI*2); ctx.fill();
        }
        ctx.restore();
    }
}

class Hero extends Obj { constructor(x,y,c,r){super(x,y);this.c=c;this.r=r;this.hp=150;this.max=150;this.t=0;} }
class Mother extends Hero {
    constructor(x,y,c,r){super(x,y,c,r);this.hp=100;this.max=100;}
    update() { 
        this.t++; 
        if(this.t>420) { game.sparks.push(new Spark(this.x, this.y, this.y)); this.t=0; } 
    }
    draw(ctx) {
        Draw.ultra(ctx, this.x+45, this.y+35, '#e53935', null);
        ctx.fillStyle='#bdbdbd'; ctx.fillRect(this.x+25, this.y+25, 8, 20); ctx.fillRect(this.x+57, this.y+25, 8, 20);
        Draw.hp(ctx, this.x+15, this.y+10, this.hp, this.max, 60);
    }
}
class Ultra extends Hero {
    constructor(x,y,c,r,type) {
        super(x,y,c,r); this.type=type; this.cd=85;
        if(type==='taro') this.cd=25; 
        if(type==='ace') this.cd=100;
        this.col = '#d32f2f'; 
        if(type==='tiga') this.col = '#7b1fa2'; 
        if(type==='ace') this.col = '#fbc02d'; 
    }
    update() {
        this.t++;
        const enemy = game.mons.some(e=>e.r===this.r && e.x>this.x);
        if(enemy && this.t>this.cd) {
            this.t=0;
            let st = 'norm';
            if(this.type==='tiga') st='ice';
            if(this.type==='seven') st='seven';
            if(this.type==='ace') st='ace';
            game.shots.push(new Shot(this.x+50, this.y+30, st));
        }
    }
    draw(ctx) {
        Draw.ultra(ctx, this.x+45, this.y+35, this.col, '#00b0ff');
        if(this.type==='seven') { 
            ctx.fillStyle='#cfd8dc';
            ctx.beginPath(); ctx.moveTo(this.x+45, this.y+10); ctx.lineTo(this.x+38, this.y+18); ctx.lineTo(this.x+52, this.y+18); ctx.fill();
        }
        Draw.hp(ctx, this.x+15, this.y+10, this.hp, this.max, 60);
    }
}

class Mon extends Obj {
    constructor(r) {
        super(CFG.W, CFG.OY + r*CFG.GH + 15);
        this.r=r; this.hp=130; this.max=130; this.spd=0.35; this.bSpd=0.35; this.frz=0;
        const rn = Math.random();
        this.type='norm'; this.col='#4e342e';
        if(rn>0.7) { this.type='cone'; this.hp=280; this.max=280; this.col='#37474f'; }
        if(rn>0.9) { this.type='bucket'; this.hp=600; this.max=600; this.col='#263238'; }
        this.ani=0;
    }
    hit(d, ice) {
        this.hp-=d;
        if(ice) { this.frz=120; this.spd=this.bSpd*0.4; }
        if(this.hp<=0) this.del=true;
    }
    update() {
        if(this.frz>0) { this.frz--; if(this.frz<=0) this.spd=this.bSpd; }
        let eat = false;
        const c = Math.floor((this.x+30-CFG.OX)/CFG.GW);
        const t = game.heroes.find(h=>h.c===c && h.r===this.r);
        if(t && Math.abs(t.x-this.x)<40) {
            t.hp-=0.6; if(t.hp<=0) t.del=true;
        } else {
            this.x-=this.spd;
        }
        if(this.x<-50) game.over();
        this.ani+=0.1;
    }
    draw(ctx) {
        const sw = Math.sin(this.ani)*3;
        const c = this.frz>0 ? '#00bcd4' : this.col;
        Draw.kaiju(ctx, this.x+30, this.y+40+sw, c, this.type);
        Draw.hp(ctx, this.x+10, this.y, this.hp, this.max, 40);
    }
}

class Game {
    constructor() {
        this.cvs = document.getElementById('gameCanvas');
        this.ctx = this.cvs.getContext('2d');
        this.run = false;
        this.eng = 10000; 
        this.frame = 0;
        this.heroes=[]; this.mons=[]; this.shots=[]; this.sparks=[];
        this.sel=null;
        this.cost={'mother':50,'man':100,'seven':125,'tiga':175,'taro':200,'ace':150};
        
        this.resize(); window.onresize=()=>this.resize();
        this.input();
    }
    resize() {
        const r = document.getElementById('game-wrapper').getBoundingClientRect();
        this.cvs.width = r.width; this.cvs.height = r.height;
    }
    input() {
        const h = (e) => {
            if(!this.run) return;
            if(e.cancelable && e.type !== 'mousedown') e.preventDefault();
            
            const rect = this.cvs.getBoundingClientRect();
            let cx, cy;
            
            if (e.touches && e.touches.length > 0) {
                cx = e.touches[0].clientX;
                cy = e.touches[0].clientY;
            } else if (e.changedTouches && e.changedTouches.length > 0) {
                cx = e.changedTouches[0].clientX;
                cy = e.changedTouches[0].clientY;
            } else {
                cx = e.clientX;
                cy = e.clientY;
            }

            const x = (cx - rect.left) * (CFG.W / rect.width);
            const y = (cy - rect.top) * (CFG.H / rect.height);
            
            for(let i=this.sparks.length-1; i>=0; i--) {
                const s = this.sparks[i];
                if(Math.hypot(s.x+25-x, s.y+25-y)<50) {
                    this.eng+=s.val; this.sparks.splice(i,1); return;
                }
            }
            if(this.sel && x>CFG.OX && y>CFG.OY) {
                const c = Math.floor((x-CFG.OX)/CFG.GW);
                const r = Math.floor((y-CFG.OY)/CFG.GH);
                if(c>=0 && c<CFG.COLS && r>=0 && r<CFG.ROWS) {
                    if(!this.heroes.some(h=>h.c===c && h.r===r)) {
                        this.addHero(c,r);
                    }
                }
            }
        };
        this.cvs.addEventListener('mousedown', h);
        this.cvs.addEventListener('touchstart', h, {passive:false});
    }
    select(t) {
        if(this.eng>=this.cost[t]) {
            this.sel=t;
            document.querySelectorAll('.card').forEach(e=>e.classList.remove('selected'));
            document.getElementById('c-'+t).classList.add('selected');
        }
    }
    addHero(c,r) {
        const x = CFG.OX+c*CFG.GW; const y = CFG.OY+r*CFG.GH;
        let h=null;
        if(this.sel==='mother') h=new Mother(x,y,c,r);
        else h=new Ultra(x,y,c,r,this.sel);
        
        if(h) {
            this.heroes.push(h); this.eng-=this.cost[this.sel];
            this.sel=null;
            document.querySelectorAll('.card').forEach(e=>e.classList.remove('selected'));
        }
    }
    start() {
        this.run=true;
        document.getElementById('start-screen').style.display='none';
        document.getElementById('ui-bar').style.display='flex';
        this.loop();
    }
    over() { this.run=false; document.getElementById('game-over').style.display='flex'; }
    
    loop() {
        if(!this.run) return;
        this.frame++;
        
        if(this.frame%320===0) this.sparks.push(new Spark(Math.random()*(CFG.W-100)+50, -50, Math.random()*300+100));
        const rate = Math.max(100, 380 - Math.floor(this.frame/100));
        if(this.frame%rate===0) this.mons.push(new Mon(Math.floor(Math.random()*CFG.ROWS)));
        
        [this.heroes, this.mons, this.shots, this.sparks].forEach(a=>{
            for(let i=a.length-1;i>=0;i--){ a[i].update(); if(a[i].del) a.splice(i,1); }
        });
        
        this.shots.forEach(s=>{
            if(s.del) return;
            for(let m of this.mons) {
                if(m.r===Math.floor((s.y-CFG.OY)/CFG.GH) && s.x>m.x && s.x<m.x+45) {
                    m.hit(s.dmg, s.type==='ice'); s.del=true; break;
                }
            }
        });
        
        this.draw();
        document.getElementById('energy-num').innerText = this.eng;
        for(let k in this.cost) {
            const el = document.getElementById('c-'+k);
            if(this.eng<this.cost[k]) el.classList.add('disabled');
            else el.classList.remove('disabled');
        }
        requestAnimationFrame(()=>this.loop());
    }
    
    draw() {
        const r = this.cvs.getBoundingClientRect();
        this.ctx.clearRect(0,0,this.cvs.width, this.cvs.height);
        this.ctx.save(); 
        
        const sx = this.cvs.width / CFG.W;
        const sy = this.cvs.height / CFG.H;
        this.ctx.scale(sx, sy);
        
        const bg = this.ctx.createLinearGradient(0,0,0,CFG.H);
        bg.addColorStop(0, '#021019'); bg.addColorStop(1, '#0a2533');
        this.ctx.fillStyle = bg; this.ctx.fillRect(0,0,CFG.W,CFG.H);
        
        this.ctx.strokeStyle = 'rgba(0, 229, 255, 0.15)'; 
        this.ctx.lineWidth = 1;
        
        for(let r=0; r<=CFG.ROWS; r++) {
            const y = CFG.OY + r*CFG.GH;
            this.ctx.beginPath(); this.ctx.moveTo(CFG.OX, y); this.ctx.lineTo(CFG.W, y); this.ctx.stroke();
        }
        
        for(let c=0; c<=CFG.COLS; c++) {
            const x = CFG.OX + c*CFG.GW;
            this.ctx.beginPath(); this.ctx.moveTo(x, CFG.OY); this.ctx.lineTo(x, CFG.H); this.ctx.stroke();
        }
        
        this.ctx.fillStyle = '#fff';
        if(Math.random()>0.9) this.ctx.fillRect(Math.random()*CFG.W, Math.random()*CFG.OY, 2, 2);
        
        this.heroes.forEach(e=>e.draw(this.ctx));
        this.mons.forEach(e=>e.draw(this.ctx));
        this.shots.forEach(e=>e.draw(this.ctx));
        this.sparks.forEach(e=>e.draw(this.ctx));
        
        this.ctx.restore();
    }
}
const game = new Game();
function startGame() { game.start(); }
</script>
</body>
</html>
