<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wallet</title>
    <style>
        /* --- iOS Design System --- */
        :root {
            --bg-base: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: rgba(60,60,67,0.6);
            --separator: #C6C6C8;
            --tint: #007AFF;
            --green: #34C759;
            --red: #FF3B30;
            --key-bg: #FFFFFF;
            --key-text: #000000;
            --key-active: #E5E5EA;
            --nav-bg: rgba(249, 249, 249, 0.85);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="dark"] {
            --bg-base: #000000;
            --bg-card: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(235,235,245,0.6);
            --separator: #38383A;
            --tint: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --key-bg: #323232;
            --key-text: #FFFFFF;
            --key-active: #5E5E5E;
            --nav-bg: rgba(29, 29, 29, 0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* Input Reset */
        input { 
            user-select: text; caret-color: var(--tint);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            color: var(--text-primary); background: transparent;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-base); color: var(--text-primary);
            height: 100vh; overflow: hidden; display: flex; justify-content: center;
        }

        #app { width: 100%; max-width: 440px; height: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; background: var(--bg-base); }

        /* Navigation */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; background: var(--bg-base);
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            z-index: 10;
        }
        .view.active { transform: translateX(0); z-index: 20; }
        
        .nav-bar {
            height: 44px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 8px; font-weight: 600; font-size: 17px;
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--separator);
            position: absolute; top: 0; width: 100%; z-index: 50;
        }
        .nav-btn { font-size: 17px; color: var(--tint); background: transparent; border: none; padding: 10px; cursor: pointer; display: flex; align-items: center; }
        .nav-btn:active { opacity: 0.5; }
        .nav-btn.icon { font-size: 22px; }
        
        .content {
            flex: 1; overflow-y: auto; padding-top: 44px; padding-bottom: calc(20px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }

        /* Lists */
        .list-group { margin: 24px 16px; border-radius: 10px; background: var(--bg-card); overflow: hidden; }
        .list-header { margin: 20px 16px 8px; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; }
        .list-item {
            display: flex; align-items: center; padding: 12px 16px; min-height: 48px;
            background: var(--bg-card); position: relative;
        }
        .list-item:not(:last-child)::after {
            content: ''; position: absolute; bottom: 0; left: 16px; right: 0; height: 0.5px; background: var(--separator);
        }
        .item-label { width: 90px; font-size: 17px; }
        .item-input { flex: 1; border: none; background: transparent; font-size: 17px; color: var(--text-primary); outline: none; padding: 0; }
        .item-input::placeholder { color: var(--text-secondary); }
        .item-arrow { color: var(--text-secondary); opacity: 0.5; font-size: 16px; font-weight: bold; }
        .item-value { font-size: 17px; color: var(--text-secondary); }

        /* Components */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #E9E9EA; transition: .4s; border-radius: 34px;
        }
        [data-theme="dark"] .slider { background-color: #39393D; }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        .btn-primary {
            display: block; width: calc(100% - 32px); margin: 24px 16px;
            background-color: var(--tint); color: #fff;
            padding: 14px; border-radius: 12px; border: none;
            font-size: 17px; font-weight: 600; text-align: center; cursor: pointer;
        }
        .btn-primary:active { opacity: 0.7; }
        .btn-text { color: var(--tint); font-size: 15px; text-align: center; margin-top: 10px; display: block; cursor: pointer; }

        /* Wallet Card */
        .wallet-card-container { margin: 20px 16px; perspective: 1000px; }
        .wallet-card {
            background: linear-gradient(135deg, #2C2C2E, #1C1C1E); color: #fff;
            padding: 24px; border-radius: 16px; position: relative; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: 0.3s;
        }
        .wallet-card.vip {
            background: linear-gradient(135deg, #000000, #1A1A1A);
            border: 1px solid rgba(255,255,255,0.15);
        }
        .balance-group { text-align: center; margin: 20px 0; cursor: pointer; }
        .balance-label { font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 4px; }
        .balance-val { font-size: 40px; font-weight: 700; letter-spacing: -1px; }
        
        .card-num-row { display: flex; align-items: center; gap: 8px; opacity: 0.85; }
        .card-copy-btn {
            background: rgba(255,255,255,0.15); border: none; color: #fff;
            width: 28px; height: 28px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; cursor: pointer; backdrop-filter: blur(4px);
        }
        .card-copy-btn:active { background: rgba(255,255,255,0.3); }

        /* Grid Menu */
        .grid-menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 0 16px; }
        .grid-item {
            background: var(--bg-card); padding: 16px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 90px;
        }
        .grid-item:active { background: var(--bg-base); }
        .grid-icon { font-size: 28px; margin-bottom: 8px; }
        .grid-text { font-size: 13px; font-weight: 500; }

        /* Keypad & Sheet */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 100;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .sheet-overlay.show { opacity: 1; pointer-events: auto; }
        
        .sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card);
            border-top-left-radius: 16px; border-top-right-radius: 16px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            padding-bottom: var(--safe-bottom);
        }
        .sheet.show { transform: translateY(0); }
        .sheet-header {
            height: 50px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; border-bottom: 0.5px solid var(--separator);
        }
        
        .pin-dots { display: flex; justify-content: center; gap: 16px; padding: 30px 0; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid var(--text-secondary); transition: 0.2s; }
        .dot.filled { background: var(--text-primary); border-color: var(--text-primary); }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 0 30px 30px; }
        .key {
            height: 70px; width: 70px; border-radius: 50%;
            background: var(--key-bg); color: var(--key-text);
            display: flex; align-items: center; justify-content: center; margin: 0 auto;
            font-size: 28px; font-weight: 400; cursor: pointer;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .key:active { background: var(--key-active); }
        .key.blank { background: transparent; box-shadow: none; cursor: default; }

        /* Toast & Admin */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(40,40,40,0.9); backdrop-filter: blur(10px); color: #fff;
            padding: 16px 24px; border-radius: 16px; font-size: 15px; z-index: 200;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .god-trigger { position: absolute; top: 10px; right: 10px; opacity: 0; width: 30px; height: 30px; }
    </style>
</head>
<body>
<div id="app">

    <!-- 1. Login -->
    <div id="view-auth" class="view active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; padding-bottom:100px;">
            <div style="text-align:center; margin-bottom: 40px;">
                <div style="width:80px; height:80px; background:var(--green); border-radius:18px; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:40px; box-shadow:0 10px 20px rgba(52,199,89,0.3);">¬•</div>
                <h1 style="font-size:28px; margin:0; font-weight:700;">Wallet</h1>
                <p style="color:var(--text-secondary); font-size:15px; margin-top:8px;">ÂÆâÂÖ®ÊîØ‰ªòÁ≥ªÁªü</p>
            </div>
            
            <div class="list-group">
                <div class="list-item">
                    <div class="item-label">Ë¥¶Âè∑</div>
                    <input type="text" id="login-user" class="item-input" placeholder="Áî®Êà∑Âêç">
                </div>
                <div class="list-item">
                    <div class="item-label">ÂØÜÁ†Å</div>
                    <input type="password" id="login-pwd" class="item-input" placeholder="ÂØÜÁ†Å">
                </div>
            </div>

            <button class="btn-primary" onclick="App.login()">ÁôªÂΩï</button>
            <div class="btn-text" onclick="UI.nav('view-reg')">Ê≥®ÂÜåÊñ∞Ë¥¶Êà∑</div>
        </div>
    </div>

    <!-- 2. Register -->
    <div id="view-reg" class="view">
        <div class="nav-bar">
            <button class="nav-btn" onclick="UI.back()">ÂèñÊ∂à</button>
            <span>Ê≥®ÂÜå</span>
            <button class="nav-btn" style="font-weight:600" onclick="App.register()">ÂÆåÊàê</button>
        </div>
        <div class="content">
            <div class="list-header">Ë¥¶Êà∑‰ø°ÊÅØ</div>
            <div class="list-group">
                <div class="list-item">
                    <div class="item-label">Áî®Êà∑Âêç</div>
                    <input type="text" id="reg-user" class="item-input" placeholder="ËÆæÁΩÆÁî®Êà∑Âêç">
                </div>
                <div class="list-item">
                    <div class="item-label">ÂØÜÁ†Å</div>
                    <input type="password" id="reg-pwd" class="item-input" placeholder="ËÆæÁΩÆÂØÜÁ†Å">
                </div>
                <div class="list-item">
                    <div class="item-label">Á°ÆËÆ§</div>
                    <input type="password" id="reg-pwd2" class="item-input" placeholder="ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å">
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Home -->
    <div id="view-home" class="view">
        <div class="nav-bar" style="background:transparent; border:none; backdrop-filter:none;">
            <div style="width:40px"></div>
            <span style="opacity:0">Èí±ÂåÖ</span>
            <button class="nav-btn icon" onclick="App.logout()">
                <div style="width:28px;height:28px;background:#C7C7CC;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;">üë§</div>
            </button>
        </div>
        <div class="content" style="padding-top:10px;">
            <div class="wallet-card-container">
                <div class="wallet-card" id="card-el">
                    <div class="god-trigger" onclick="Admin.edit()"></div>
                    <div style="display:flex; justify-content:space-between; opacity:0.7; font-size:13px; font-weight:500;">
                        <span>UPB CARD</span>
                        <span>CNY</span>
                    </div>
                    <div class="balance-group" onclick="UI.toggleEye()">
                        <div class="balance-label" id="eye-txt">ÁÇπÂáªÊü•Áúã‰ΩôÈ¢ù</div>
                        <div class="balance-val" id="home-balance">****</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:20px;">
                        <div class="card-num-row">
                            <span style="font-family:'Courier New', monospace; font-size:15px;" id="home-card">.... .... .... ....</span>
                            <button class="card-copy-btn" onclick="UI.copyCard()">‚ùê</button>
                        </div>
                        <div style="width:30px; height:30px; background:rgba(255,255,255,0.2); border-radius:50%;"></div>
                    </div>
                </div>
            </div>

            <div class="grid-menu">
                <div class="grid-item" onclick="UI.nav('view-pay')">
                    <span class="grid-icon" style="color:var(--green)">üí∏</span>
                    <span class="grid-text">ËΩ¨Ë¥¶</span>
                </div>
                <div class="grid-item" onclick="UI.nav('view-rec')">
                    <span class="grid-icon" style="color:#FF9500">üì•</span>
                    <span class="grid-text">Êî∂Ê¨æ</span>
                </div>
                <div class="grid-item" onclick="UI.nav('view-bill')">
                    <span class="grid-icon" style="color:var(--tint)">üìÑ</span>
                    <span class="grid-text">Ë¥¶Âçï</span>
                </div>
                <div class="grid-item" onclick="UI.nav('view-set')">
                    <span class="grid-icon" style="color:var(--text-secondary)">‚öôÔ∏è</span>
                    <span class="grid-text">ËÆæÁΩÆ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Pay -->
    <div id="view-pay" class="view">
        <div class="nav-bar">
            <button class="nav-btn" onclick="UI.back()">ËøîÂõû</button>
            <span>ËΩ¨Ë¥¶</span>
            <div style="width:40px"></div>
        </div>
        <div class="content">
            <div style="text-align:center; padding: 30px 0;">
                <div style="font-size:15px; color:var(--text-secondary);">ÈáëÈ¢ù</div>
                <div style="font-size:40px; font-weight:600; margin-top:5px; display:flex; justify-content:center; align-items:center;">
                    ¬• <input type="number" id="pay-amt" placeholder="0.00" style="width:200px; border:none; background:transparent; font-size:40px; font-weight:600; text-align:center; outline:none; color:var(--text-primary);">
                </div>
            </div>

            <div class="list-group">
                <div class="list-item">
                    <div class="item-label">Âç°Âè∑</div>
                    <input type="tel" id="pay-target" class="item-input" placeholder="Êî∂Ê¨æ‰∫∫Âç°Âè∑ (ÂøÖÂ°´)" oninput="UI.fmtCard(this)" maxlength="23">
                </div>
                <div class="list-item">
                    <div class="item-label">Â§áÊ≥®</div>
                    <input type="text" id="pay-note" class="item-input" placeholder="ËΩ¨Ë¥¶ËØ¥Êòé">
                </div>
            </div>

            <button class="btn-primary" onclick="App.prePay()">‰∏ã‰∏ÄÊ≠•</button>
        </div>
    </div>

    <!-- 5. Receive -->
    <div id="view-rec" class="view">
        <div class="nav-bar">
            <button class="nav-btn" onclick="UI.back()">ËøîÂõû</button>
            <span>Êî∂Ê¨æ</span>
            <button class="nav-btn" onclick="App.redeem()" style="font-weight:600">Á°ÆËÆ§</button>
        </div>
        <div class="content">
            <div class="list-header">Âá≠ËØÅ‰ª£Á†Å</div>
            <div class="list-group">
                <div class="list-item" style="height:120px; align-items:flex-start;">
                    <textarea id="rec-token" style="width:100%; height:100%; border:none; background:transparent; font-size:15px; resize:none; outline:none; color:var(--text-primary); font-family:monospace;" placeholder="Á≤òË¥¥ UPB- ÂºÄÂ§¥ÁöÑÂ≠óÁ¨¶‰∏≤..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Settings -->
    <div id="view-set" class="view">
        <div class="nav-bar">
            <button class="nav-btn" onclick="UI.back()">ËøîÂõû</button>
            <span>ËÆæÁΩÆ</span>
            <div style="width:40px"></div>
        </div>
        <div class="content">
            <div class="list-group">
                <div class="list-item" onclick="App.setupPin()">
                    <div class="item-label" style="flex:1">ÊîØ‰ªòÂØÜÁ†Å</div>
                    <div class="item-value" id="pin-status">Êú™ËÆæÁΩÆ</div>
                    <div class="item-arrow" style="margin-left:8px">‚Ä∫</div>
                </div>
            </div>

            <div class="list-group">
                <div class="list-item">
                    <div class="item-label" style="flex:1">Ê∑±Ëâ≤Ê®°Âºè</div>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch" onchange="UI.toggleTheme()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="list-group">
                <div class="list-item" onclick="App.logout()" style="justify-content:center;">
                    <div style="color:var(--red); font-weight:500;">ÈÄÄÂá∫ÁôªÂΩï</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. Bill -->
    <div id="view-bill" class="view">
        <div class="nav-bar">
            <button class="nav-btn" onclick="UI.back()">ËøîÂõû</button>
            <span>Ë¥¶Âçï</span>
            <div style="width:40px"></div>
        </div>
        <div class="content" id="bill-list"></div>
    </div>

    <!-- Keypad Sheet -->
    <div class="sheet-overlay" id="sheet-overlay">
        <div class="sheet" id="sheet">
            <div class="sheet-header">
                <div style="width:40px"></div>
                <div style="font-weight:600" id="kb-title">ËØ∑ËæìÂÖ•ÂØÜÁ†Å</div>
                <button class="nav-btn" onclick="Security.close()">ÂèñÊ∂à</button>
            </div>
            <div class="pin-dots" id="pin-dots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <div class="numpad">
                <div class="key" onclick="Security.tap(1)">1</div>
                <div class="key" onclick="Security.tap(2)">2</div>
                <div class="key" onclick="Security.tap(3)">3</div>
                <div class="key" onclick="Security.tap(4)">4</div>
                <div class="key" onclick="Security.tap(5)">5</div>
                <div class="key" onclick="Security.tap(6)">6</div>
                <div class="key" onclick="Security.tap(7)">7</div>
                <div class="key" onclick="Security.tap(8)">8</div>
                <div class="key" onclick="Security.tap(9)">9</div>
                <div class="key blank"></div>
                <div class="key" onclick="Security.tap(0)">0</div>
                <div class="key blank" onclick="Security.tap('del')" style="font-size:22px">‚å´</div>
            </div>
        </div>
    </div>

    <!-- Result View -->
    <div id="view-result" class="view" style="z-index:100; background:rgba(0,0,0,0.6); backdrop-filter:blur(10px); justify-content:center; align-items:center;">
        <div style="background:var(--bg-card); width:85%; border-radius:18px; padding:30px 20px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,0.3);">
            <div style="width:60px; height:60px; background:var(--green); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px; color:#fff; font-size:30px;">‚úì</div>
            <h2 style="margin:0; font-size:20px;">ÊîØ‰ªòÊàêÂäü</h2>
            <p style="font-size:32px; font-weight:700; margin:10px 0;">- <span id="res-amt">0.00</span></p>
            <div style="background:var(--bg-base); padding:12px; border-radius:10px; font-family:monospace; font-size:13px; word-break:break-all; margin:24px 0; color:var(--text-secondary);" id="res-token"></div>
            <button class="btn-primary" style="margin:0; width:100%" onclick="UI.copyResult()">Â§çÂà∂Âá≠ËØÅ</button>
            <div class="btn-text" onclick="UI.closeResult()">ÂÖ≥Èó≠</div>
        </div>
    </div>

</div>

<script>
/**
 * UPB Wallet v7.2 - Final Integration
 */
const CONFIG = { GOD:'ÂÆáÂÆôÂÆôÈïø', PASS:'wuwangze123', SALT:'UPB_V7_FINAL' };

const DB = {
    get: (k) => JSON.parse(localStorage.getItem(k)||'{}'),
    set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
    genCard: () => {
        let c = "622202" + Math.floor(Math.random()*1e9).toString().padStart(9,'0');
        let s=0; for(let i=0;i<c.length;i++) s+=parseInt(c[i]);
        return (c+(s%10)).replace(/(.{4})/g,"$1 ").trim();
    }
};

const Security = {
    pin: [], cb: null,
    hash: (s) => { let h=0x811c9dc5; for(let i=0;i<s.length;i++)h=Math.imul(h^s.charCodeAt(i),0x1000193); return (h>>>0).toString(16); },
    token: (f,t,a,m) => {
        const d = {f,t,a,ts:Date.now(),n:Math.random().toString(36).substr(2),m};
        const j = JSON.stringify(d);
        return "UPB-"+btoa(unescape(encodeURIComponent(j)))+"."+Security.hash(j+CONFIG.SALT);
    },
    verify: (s) => {
        if(!s.startsWith("UPB-")) return {ok:false};
        try {
            const [b,g] = s.substring(4).split('.');
            const j = decodeURIComponent(escape(atob(b)));
            return Security.hash(j+CONFIG.SALT)===g ? {ok:true,d:JSON.parse(j)} : {ok:false};
        } catch{return{ok:false};}
    },
    open: (t,cb) => {
        document.getElementById('kb-title').innerText=t; Security.pin=[]; Security.cb=cb;
        Security.render(); 
        document.getElementById('sheet-overlay').classList.add('show');
        document.getElementById('sheet').classList.add('show');
    },
    close: () => {
        document.getElementById('sheet-overlay').classList.remove('show');
        document.getElementById('sheet').classList.remove('show');
    },
    render: () => {
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d,i) => {
            if(i<Security.pin.length) d.classList.add('filled'); else d.classList.remove('filled');
        });
    },
    tap: (v) => {
        if(v==='del') Security.pin.pop(); else if(Security.pin.length<6) Security.pin.push(v);
        Security.render();
        if(Security.pin.length===6 && Security.cb) setTimeout(()=>Security.cb(Security.pin.join('')),100);
    }
};

const UI = {
    stack: ['view-auth'],
    nav: (id) => {
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        UI.stack.push(id);
        if(id==='view-home') App.renderHome();
        if(id==='view-bill') App.renderBill();
        if(id==='view-set') App.renderSet();
    },
    back: () => {
        if(UI.stack.length<=1) return;
        UI.stack.pop();
        const p = UI.stack[UI.stack.length-1];
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(p).classList.add('active');
        if(p==='view-home') App.renderHome();
    },
    toast: (m) => {
        const d=document.createElement('div'); d.className='toast'; d.innerText=m;
        document.body.appendChild(d); setTimeout(()=>d.remove(),2000);
    },
    toggleTheme: () => {
        const el = document.documentElement;
        const cur = el.getAttribute('data-theme');
        const next = cur==='light'?'dark':'light';
        el.setAttribute('data-theme', next);
        localStorage.setItem('upb_theme', next);
        document.getElementById('theme-switch').checked = (next==='dark');
    },
    toggleEye: () => {
        const el = document.getElementById('home-balance');
        const txt = document.getElementById('eye-txt');
        const isHidden = el.innerText.includes('*');
        el.innerText = isHidden ? App.fmt(App.wallet.balance) : "****";
        txt.innerText = isHidden ? "ÈöêËóè‰ΩôÈ¢ù" : "ÁÇπÂáªÊü•Áúã‰ΩôÈ¢ù";
    },
    fmtCard: (e) => e.value = e.value.replace(/\D/g,'').substring(0,19).replace(/(\d{4})(?=\d)/g,"$1 "),
    copyCard: () => {
        const num = document.getElementById('home-card').innerText;
        navigator.clipboard.writeText(num).then(() => UI.toast('Âç°Âè∑Â∑≤Â§çÂà∂'));
    },
    copyResult: () => { navigator.clipboard.writeText(document.getElementById('res-token').innerText).then(()=>UI.toast('Â∑≤Â§çÂà∂')); },
    closeResult: () => { document.getElementById('view-result').classList.remove('active'); UI.back(); }
};

const App = {
    u:null, c:null, wallet:null, isGod:false, sdkReq:null, pendingSdkReq:null,
    fmt: (n) => parseFloat(n).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'),
    
    init: () => {
        const t = localStorage.getItem('upb_theme');
        if(t) {
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('theme-switch').checked = (t==='dark');
        }
        const u = localStorage.getItem('upb_last');
        if(u) document.getElementById('login-user').value=u;
        window.addEventListener("message", App.onMsg);
    },

    login: () => {
        const u=document.getElementById('login-user').value.trim();
        const p=document.getElementById('login-pwd').value;
        const users=DB.get('upb_users');

        if(u===CONFIG.GOD && p===CONFIG.PASS) {
            App.isGod=true; App.setup(u, users[u]||App.mockGod(u));
            UI.toast("Ê¨¢ËøéÂΩíÊù•ÔºåÂÆáÂÆôÂÆôÈïø");
            return;
        }
        if(users[u] && users[u].pwd===p) {
            App.isGod=false; App.setup(u, users[u]);
        } else {
            UI.toast("Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØ");
        }
    },

    setup: (u, data) => {
        App.u=u; App.c=data.card;
        App.wallet = DB.get('upb_data_'+App.c);
        if(!App.wallet) return UI.toast("Êï∞ÊçÆÂºÇÂ∏∏");
        localStorage.setItem('upb_last', u);
        UI.nav('view-home');
        
        if(!App.wallet.pin) {
            setTimeout(() => {
                if(confirm("ÂÆâÂÖ®ÊèêÁ§∫ÔºöÊÇ®Â∞öÊú™ËÆæÁΩÆÊîØ‰ªòÂØÜÁ†ÅÔºåÊòØÂê¶Áé∞Âú®ËÆæÁΩÆÔºü")) UI.nav('view-set');
            }, 500);
        }

        if (App.pendingSdkReq) {
            setTimeout(() => {
                UI.toast("Â§ÑÁêÜ‰πãÂâçÁöÑÊîØ‰ªòËØ∑Ê±Ç");
                App.handleSdkReq(App.pendingSdkReq);
                App.pendingSdkReq = null;
            }, 500);
        }
    },

    mockGod: (u) => {
        const users=DB.get('upb_users');
        const c="8888888888888888";
        users[u]={pwd:CONFIG.PASS, card:c};
        DB.set('upb_users', users);
        DB.set('upb_data_'+c, {balance:99999999.99, pin:"888888", history:[], used:[]});
        return users[u];
    },

    register: () => {
        const u=document.getElementById('reg-user').value.trim();
        const p=document.getElementById('reg-pwd').value;
        const p2=document.getElementById('reg-pwd2').value;
        if(!u||!p) return UI.toast("ËØ∑Â°´ÂÜôÂÆåÊï¥");
        if(p!==p2) return UI.toast("ÂØÜÁ†Å‰∏ç‰∏ÄËá¥");
        
        const users=DB.get('upb_users');
        if(users[u]) return UI.toast("Áî®Êà∑Â∑≤Â≠òÂú®");

        const c=DB.genCard();
        users[u]={pwd:p, card:c};
        DB.set('upb_users', users);
        DB.set('upb_data_'+c, {balance:0.00, pin:null, history:[{t:Date.now(), type:'Ë¥¶Êà∑ÂºÄÁ´ã', amt:0, note:'Êñ∞Áî®Êà∑Ê≥®ÂÜå'}], used:[]});
        
        UI.toast("Ê≥®ÂÜåÊàêÂäü");
        document.getElementById('login-user').value=u;
        document.getElementById('login-pwd').value=p;
        UI.back();
    },

    logout: () => {
        App.u=null; UI.stack=['view-auth'];
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById('view-auth').classList.add('active');
    },

    renderHome: () => {
        document.getElementById('home-card').innerText=App.c;
        document.getElementById('home-balance').innerText="****";
        document.getElementById('eye-txt').innerText="ÁÇπÂáªÊü•Áúã‰ΩôÈ¢ù";
        const el = document.getElementById('card-el');
        if(App.wallet.balance>=1000000) el.classList.add('vip'); else el.classList.remove('vip');
    },

    renderBill: () => {
        const l=App.wallet.history;
        const el=document.getElementById('bill-list');
        if(!l.length) { el.innerHTML='<div style="text-align:center;color:var(--text-secondary);margin-top:40px;">ÊöÇÊó†ËÆ∞ÂΩï</div>'; return; }
        el.innerHTML = `<div class="list-group">` + l.map(h => `
            <div class="list-item" style="justify-content:space-between;">
                <div><div style="font-size:16px;">${h.note||h.type}</div><div style="font-size:12px;color:var(--text-secondary);">${new Date(h.t).toLocaleDateString()}</div></div>
                <div style="font-weight:600;color:${h.amt>0?'var(--green)':'var(--text-primary)'}">${h.amt>0?'+':''}${App.fmt(h.amt)}</div>
            </div>`).join('') + `</div>`;
    },

    renderSet: () => {
        const status = document.getElementById('pin-status');
        status.innerText = App.wallet.pin ? "Â∑≤ËÆæÁΩÆ" : "Êú™ËÆæÁΩÆ";
        status.style.color = App.wallet.pin ? "var(--text-secondary)" : "var(--red)";
    },

    setupPin: () => {
        Security.open("ËÆæÁΩÆÊîØ‰ªòÂØÜÁ†Å", (p)=>{
            App.wallet.pin=p; DB.set('upb_data_'+App.c, App.wallet);
            Security.close(); UI.toast("ÂØÜÁ†ÅÂ∑≤ËÆæÁΩÆ"); App.renderSet();
        });
    },

    prePay: () => {
        const amt=parseFloat(document.getElementById('pay-amt').value);
        if(!amt||amt<=0) return UI.toast("ÈáëÈ¢ùÊó†Êïà");
        if(amt>App.wallet.balance) return UI.toast("‰ΩôÈ¢ù‰∏çË∂≥");
        if(!App.wallet.pin) return UI.toast("ËØ∑ÂÖàËÆæÁΩÆÊîØ‰ªòÂØÜÁ†Å");
        
        const target = document.getElementById('pay-target').value.replace(/\s/g,'');
        if(!target || target.length < 16) return UI.toast("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂØπÊñπÂç°Âè∑");

        Security.open(`ÊîØ‰ªò ¬•${amt}`, (p)=>{
            if(p===App.wallet.pin) App.doPay(amt, target);
            else { UI.toast("ÂØÜÁ†ÅÈîôËØØ"); Security.pin=[]; Security.render(); }
        });
    },

    doPay: (amt, target) => {
        Security.close();
        const note = document.getElementById('pay-note').value||'ËΩ¨Ë¥¶';
        App.wallet.balance-=amt;
        App.wallet.history.unshift({t:Date.now(), type:'ËΩ¨Ë¥¶ÊîØÂá∫', amt:-amt, note});
        DB.set('upb_data_'+App.c, App.wallet);
        
        const t = Security.token(App.c, target, amt, note);
        
        // SDK Mode: Silent success & return
        if(App.sdkReq) {
            // TARGET ORIGIN IS '*' TO ALLOW LOCAL FILESYSTEM / CROSS-ORIGIN TESTING
            App.sdkReq.s.postMessage({action:'UPB_PAY_SUCCESS', token:t}, '*');
            App.sdkReq = null;
            UI.toast("ÊîØ‰ªòÊàêÂäü");
            UI.nav('view-home');
            return;
        }

        // Normal Mode: Show Receipt
        document.getElementById('res-amt').innerText = App.fmt(amt);
        document.getElementById('res-token').innerText = t;
        document.getElementById('view-result').classList.add('active');
    },

    redeem: () => {
        const txt=document.getElementById('rec-token').value.trim();
        if(!txt) return;
        const res=Security.verify(txt);
        if(!res.ok) return UI.toast("Âá≠ËØÅÊó†Êïà");
        const d=res.d;
        if(App.wallet.used.includes(d.n)) return UI.toast("Âá≠ËØÅÂ∑≤Â§±Êïà");
        if(d.t && d.t.replace(/\s/g,'')!==App.c.replace(/\s/g,'')) return UI.toast("ÈùûÊåáÂÆöÊî∂Ê¨æ‰∫∫ÔºåÊó†Ê≥ïÊî∂Ê¨æ");

        App.wallet.balance+=parseFloat(d.a);
        App.wallet.used.push(d.n);
        App.wallet.history.unshift({t:Date.now(), type:'Êî∂Ê¨æ', amt:d.a, note:d.m||'Êî∂Ê¨æ'});
        DB.set('upb_data_'+App.c, App.wallet);
        UI.toast("Êî∂Ê¨æÊàêÂäü"); UI.back();
    },

    onMsg: (e) => {
        if(e.data?.action==='UPB_PAY_REQ') {
            const req = { s: e.source, o: e.origin, data: e.data };
            if (App.u) App.handleSdkReq(req);
            else {
                App.pendingSdkReq = req;
                UI.toast("Êî∂Âà∞ÊîØ‰ªòËØ∑Ê±ÇÔºåËØ∑ÁôªÂΩï");
            }
        }
    },

    handleSdkReq: (req) => {
        App.sdkReq = { s: req.s, o: req.o };
        UI.nav('view-pay');
        document.getElementById('pay-amt').value = req.data.amount;
        document.getElementById('pay-note').value = req.data.note || "Á¨¨‰∏âÊñπÊîØ‰ªò";
        // Auto-fill God Card as Merchant
        document.getElementById('pay-target').value = "8888 8888 8888 8888"; 
    }
};

const Admin = { edit: () => {
    const n=prompt("GOD MODE: SET BALANCE", App.wallet.balance);
    if(n!==null&&!isNaN(n)) { App.wallet.balance=parseFloat(n); DB.set('upb_data_'+App.c, App.wallet); App.renderHome(); }
}};

App.init();
</script>
</body>
</html>
