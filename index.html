

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂÆôÈïøÁüøÂ∑• - Ê∑±Á©∫Èú∏‰∏ª (Êó†ÊïåÁâà)</title>
    <style>
        /* ÂºïÂÖ•ÁßëÂπªÂ≠ó‰Ωì */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');

        /* === ÂÖ®Â±ÄÂü∫Á°Ä === */
        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #000;
            font-family: 'Orbitron', 'Microsoft YaHei', 'SimHei', sans-serif;
            user-select: none; -webkit-user-select: none; touch-action: none;
            color: #0ff;
        }

        /* Ê∏∏ÊàèÂÆπÂô® */
        #game-container {
            position: relative; width: 100vw; height: 100vh;
            background: radial-gradient(circle at center, #0b1021 0%, #000000 100%);
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        canvas {
            box-shadow: 0 0 60px rgba(0, 200, 255, 0.15);
            border: 1px solid rgba(0, 255, 255, 0.2);
            z-index: 1;
        }

        /* === ÁßòÁ±çËæìÂÖ•Ê°Ü === */
        #cheat-box {
            position: absolute;
            top: 80px; right: 10px;
            width: 100px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            z-index: 2000;
            outline: none;
            text-align: center;
            border-radius: 4px;
            transition: 0.3s;
        }
        #cheat-box:focus {
            background: rgba(0, 20, 40, 0.8); border-color: #0ff; color: #fff; box-shadow: 0 0 10px #0ff;
        }
        #cheat-box::placeholder { color: rgba(255,255,255,0.2); }

        /* === Êñ∞Â¢ûÔºöÁ©∫Èó¥Ë∑≥Ë∑ÉÊåâÈíÆ (ËøáÂÖ≥ÊåâÈíÆ) === */
        #warp-btn {
            position: absolute;
            top: 130px; left: 50%;
            transform: translateX(-50%);
            padding: 10px 30px;
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #0ff;
            color: #fff;
            font-family: 'Orbitron', "Microsoft YaHei", sans-serif;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 0 30px #0ff;
            z-index: 500;
            display: none; /* ÈªòËÆ§ÈöêËóè */
            animation: pulseBtn 1.5s infinite ease-in-out;
            backdrop-filter: blur(5px);
            text-shadow: 0 0 5px #fff;
        }
        #warp-btn:hover {
            background: rgba(0, 255, 255, 0.6);
            color: #000;
        }
        @keyframes pulseBtn {
            0% { transform: translateX(-50%) scale(1); box-shadow: 0 0 20px #0ff; }
            50% { transform: translateX(-50%) scale(1.05); box-shadow: 0 0 40px #0ff; }
            100% { transform: translateX(-50%) scale(1); box-shadow: 0 0 20px #0ff; }
        }

        /* === Loading ÈÅÆÁΩ©Â±Ç === */
        #loading-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .loader-ring {
            width: 80px; height: 80px;
            border: 4px solid rgba(0, 255, 255, 0.2);
            border-top: 4px solid #0ff; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
        }
        .loader-text { font-size: 24px; color: #0ff; letter-spacing: 2px; margin-bottom: 10px; font-weight: bold; }
        .loader-slogan {
            font-size: 18px; color: #ffd700; margin-bottom: 20px; text-align: center; line-height: 1.6;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); opacity: 0; animation: fadeIn 2s ease-in forwards;
        }
        .loader-log { font-family: 'Courier New', monospace; font-size: 12px; color: #0a0; height: 20px; opacity: 0.8; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }

        /* === UI Â±Ç === */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .hud {
            position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-around;
            padding: 0 10px; box-sizing: border-box;
        }
        .hud-panel {
            background: rgba(10, 20, 35, 0.85); border: 1px solid rgba(0, 255, 255, 0.3); border-left: 4px solid #0ff;
            padding: 8px 15px; min-width: 70px; transform: skewX(-15deg);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1); backdrop-filter: blur(4px);
        }
        .hud-content { transform: skewX(15deg); text-align: center; }
        .hud-label { font-size: 12px; color: #88aaff; letter-spacing: 1px; display: block; font-family: "Microsoft YaHei"; }
        .hud-val { font-size: 22px; font-weight: 700; color: #fff; text-shadow: 0 0 8px rgba(0, 255, 255, 0.8); }
        .text-gold { color: #ffd700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.6); }
        .text-red { color: #ff4444; text-shadow: 0 0 8px rgba(255, 68, 68, 0.6); }

        #game-logo {
            position: absolute; top: 12%; left: 50%; transform: translate(-50%, -50%);
            font-size: 60px; font-weight: 900; color: rgba(255, 255, 255, 0.05);
            pointer-events: none; white-space: nowrap; letter-spacing: 15px; z-index: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        .controls {
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between;
            padding: 0 50px; box-sizing: border-box; pointer-events: auto;
        }
        .ctrl-btn {
            width: 110px; height: 110px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; backdrop-filter: blur(10px); transition: transform 0.1s, box-shadow 0.2s;
            position: relative; overflow: hidden; font-family: "Microsoft YaHei"; font-weight: bold; font-size: 16px;
        }
        .ctrl-btn:active { transform: scale(0.92); }
        .ctrl-btn::before { content:''; position: absolute; width: 100%; height: 100%; border-radius: 50%; box-shadow: inset 0 0 20px rgba(255,255,255,0.2); }
        .btn-shoot { background: radial-gradient(circle, rgba(0,255,255,0.2) 0%, rgba(0,0,0,0.8) 100%); border-color: #0ff; box-shadow: 0 0 30px rgba(0,255,255,0.3); color: #0ff; }
        .btn-bomb { background: radial-gradient(circle, rgba(255,50,50,0.2) 0%, rgba(0,0,0,0.8) 100%); border-color: #ff3333; box-shadow: 0 0 30px rgba(255,0,0,0.3); color: #ffaaaa; }

        /* ÂºπÁ™ó Modal */
        #modal-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px); z-index: 100; display: none; justify-content: center; align-items: center; pointer-events: auto;
        }
        .modal-box {
            background: rgba(10, 25, 40, 0.95); border: 1px solid #0ff; padding: 40px; text-align: center;
            max-width: 400px; min-width: 300px; box-shadow: 0 0 50px rgba(0,255,255,0.2); position: relative;
        }
        .modal-box::after { content: ''; position: absolute; top: -2px; left: -2px; width: 20px; height: 20px; border-top: 3px solid #0ff; border-left: 3px solid #0ff; }
        .modal-box::before { content: ''; position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; border-bottom: 3px solid #0ff; border-right: 3px solid #0ff; }
        .modal-title { font-size: 32px; margin: 0 0 20px; color: #fff; text-shadow: 0 0 10px #0ff; font-family: "Microsoft YaHei"; }
        .modal-text { font-family: "Microsoft YaHei", sans-serif; font-size: 18px; color: #ccc; line-height: 1.6; margin-bottom: 30px; }
        .action-btn {
            background: transparent; border: 2px solid #0ff; color: #0ff; padding: 12px 40px;
            font-size: 18px; font-family: "Microsoft YaHei", sans-serif; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .action-btn:hover { background: #0ff; color: #000; box-shadow: 0 0 20px #0ff; }

        /* ÊµÆÂä®ÊñáÂ≠ó */
        .float-text {
            position: absolute; font-weight: 900; font-size: 24px; pointer-events: none;
            animation: floatUp 1.2s forwards; text-shadow: 2px 2px 0 #000; z-index: 50; font-family: "Microsoft YaHei";
        }
        @keyframes floatUp { 0% { transform: translateY(0); opacity:1; } 100% { transform: translateY(-80px); opacity:0; } }
    </style>
</head>
<body>

<div id="loading-layer">
    <div class="loader-ring"></div>
    <div class="loader-text">Á≥ªÁªüÂàùÂßãÂåñ‰∏≠</div>
    <div class="loader-slogan">ÈªÑÈáëÁüøÂ∑•‰∏çÂ¶ÇÊ∑±ÈÇÉÊòüÁ©∫<br>ÈªÑÈáë‰∏á‰∏§‰∏çÂ¶ÇÊøÄÂÖâ‰∏ÄÂìç</div>
    <div class="loader-log" id="loading-log">Ê≠£Âú®ËøûÊé•‰∏ªÊú∫...</div>
</div>

<div id="game-container">
    <div id="game-logo">ÂÆôÈïøÁüøÂ∑•</div>
    <canvas id="canvas"></canvas>

    <!-- ÁßòÁ±çËæìÂÖ•Ê°Ü -->
    <input type="text" id="cheat-box" placeholder="CMD..." autocomplete="off">
    
    <!-- ÊâãÂä®ËøáÂÖ≥ÊåâÈíÆ (ÈªòËÆ§ÈöêËóè) -->
    <div id="warp-btn">üöÄ Á©∫Èó¥Ë∑≥Ë∑É (ËøõÂÖ•‰∏ã‰∏ÄÂÖ≥)</div>

    <div id="ui-layer">
        <div class="hud">
            <div class="hud-panel">
                <div class="hud-content">
                    <span class="hud-label">ÁõÆÊ†áËÉΩÈáè</span>
                    <span class="hud-val text-gold" id="ui-target">0</span>
                </div>
            </div>
            <div class="hud-panel">
                <div class="hud-content">
                    <span class="hud-label">ÂΩìÂâçËÉΩÈáè</span>
                    <span class="hud-val text-gold" id="ui-money">0</span>
                </div>
            </div>
            <div class="hud-panel">
                <div class="hud-content">
                    <span class="hud-label">Ââ©‰ΩôÊó∂Èó¥</span>
                    <span class="hud-val text-red" id="ui-time">60</span>
                </div>
            </div>
            <div class="hud-panel">
                <div class="hud-content">
                    <span class="hud-label">ÊòüÂå∫</span>
                    <span class="hud-val" id="ui-level">1</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="ctrl-btn btn-bomb" id="btn-bomb">
                <div>ÂÖâÂ≠êÈ±ºÈõ∑</div>
                <div style="font-size:14px; margin-top:5px">x<span id="ui-bomb">0</span></div>
            </div>
            <div class="ctrl-btn btn-shoot" id="btn-shoot">
                <div>ÂèëÂ∞ÑÊøÄÂÖâ</div>
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™ó -->
    <div id="modal-overlay">
        <div class="modal-box">
            <h2 class="modal-title" id="modal-title">Ê†áÈ¢ò</h2>
            <div class="modal-text" id="modal-content">ÂÜÖÂÆπ</div>
            <button class="action-btn" id="modal-btn">ÊåâÈíÆ</button>
        </div>
    </div>
</div>

<script>
/**
 * ÈÖçÁΩÆÂ∏∏Èáè
 */
const CONFIG = {
    DESIGN_W: 1024,
    DESIGN_H: 768,
    HOOK_SPEED_OUT: 9,
    HOOK_SPEED_IN: 13,
    HOOK_ORIGIN_Y: 85,
    SWING_SPEED: 1.3,
    MAX_ANGLE: 75,
    TIME_LIMIT: 60
};

/**
 * ÂÆáÂÆôÂ§©‰ΩìÂõæÈâ¥
 */
const CATALOG = {
    SUN: { type: 'star', val: 1000, weight: 18, radius: 60, name: 'Â§™Èò≥', color: ['#ffaa00', '#ff4400'] },
    SIRIUS: { type: 'star', val: 1200, weight: 20, radius: 55, name: 'Â§©ÁãºÊòü A', color: ['#fff', '#00ccff'] },
    EARTH: { type: 'planet_land', val: 200, weight: 5, radius: 28, name: 'Âú∞ÁêÉ', color: ['#1a44cc', '#112244'] },
    MARS: { type: 'planet', val: 150, weight: 3, radius: 24, name: 'ÁÅ´Êòü', color: ['#ff5533', '#882211'] },
    JUPITER: { type: 'planet_band', val: 600, weight: 12, radius: 48, name: 'Êú®Êòü', color: ['#d4a373', '#805b38'] },
    SATURN: { type: 'saturn', val: 700, weight: 14, radius: 40, name: 'ÂúüÊòü', color: ['#e0c090', '#a08050'] },
    NEPTUNE: { type: 'planet', val: 400, weight: 7, radius: 32, name: 'Êµ∑ÁéãÊòü', color: ['#3355ff', '#111188'] },
    KEPLER: { type: 'planet_land', val: 550, weight: 8, radius: 30, name: 'ÂºÄÊôÆÂãí-22b', color: ['#22ccaa', '#004433'] },
    BLACK_HOLE: { type: 'blackhole', val: 2000, weight: 35, radius: 35, name: 'ÈªëÊ¥û', color: ['#000', '#500050'] },
    WORMHOLE: { type: 'wormhole', val: 888, weight: 10, radius: 25, name: 'Ëô´Ê¥û', color: ['#9900ff', '#fff'] },
    UFO: { type: 'ufo', val: 666, weight: 4, radius: 20, name: 'UFO È£ûÁ¢ü', color: ['#0f0', '#222'], move: true, speed: 1.5 },
    VOYAGER: { type: 'ship', val: 450, weight: 2, radius: 18, name: 'ÊóÖË°åËÄÖÂè∑', color: ['#ccc', '#gold'], move: true, speed: 0.8 },
    ISS: { type: 'station', val: 300, weight: 5, radius: 25, name: 'Á©∫Èó¥Á´ô', color: ['#eee', '#444'], move: true, speed: 0.5 },
    CRYSTAL: { type: 'crystal', val: 900, weight: 1, radius: 15, name: 'ÂáØ‰ºØÊô∂‰Ωì', color: ['#00ffff', '#fff'] },
    BAG: { type: 'bag', val: 0, weight: 2, radius: 22, name: 'Á•ûÁßò‰ø°Âè∑', color: ['#ff00ff', '#330033'] },
    ASTEROID_S: { type: 'rock', val: 15, weight: 4, radius: 16, name: '', color: ['#666', '#444'] },
    ASTEROID_L: { type: 'rock', val: 40, weight: 15, radius: 42, name: '', color: ['#555', '#333'] },
    MINE: { type: 'mine', val: 10, weight: 1, radius: 18, name: 'Â§™Á©∫Èõ∑', color: ['#f00', '#500'] }
};

class Game {
    constructor() {
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        
        // Ê∏∏ÊàèÁä∂ÊÄÅÊï∞ÊçÆ
        this.level = 1;
        this.money = 0;
        this.target = 0;
        this.bombs = 0;
        this.time = 0;
        this.state = 'LOADING'; 
        this.scale = 1;
        this.isGodMode = false;

        // ÂÆû‰Ωì
        this.hook = {
            angle: 0, dir: 1, len: 40, status: 0, 
            x: 0, y: 0, item: null
        };
        this.items = [];
        this.particles = [];
        this.bgStars = [];

        // ÁªëÂÆö‰∏ä‰∏ãÊñá
        this.loop = this.loop.bind(this);
        this.resize = this.resize.bind(this);

        this.initEvents();
        this.initCheat();
        this.resize();
        window.addEventListener('resize', this.resize);

        // Ê®°ÊãüÂä†ËΩΩ
        this.simulateLoading().then(() => {
            this.loadSave();
            if (this.money === 0 && this.level === 1) this.startLevel(1);
            else this.showModal(`Á¨¨ ${this.level} ÊòüÂå∫`, `Êú¨ÂÖ≥ÁõÆÊ†á: <span style="color:#ffd700">${this.calcTarget(this.level)}</span>`, 'ÂºÄÂßãÈááÈõÜ', () => this.startLevel(this.level));
            
            requestAnimationFrame(this.loop);
        });
    }

    initCheat() {
        const input = document.getElementById('cheat-box');
        input.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            if (val === 'wudi') {
                this.isGodMode = true;
                this.showFloat("‚òÖ ÂºÄÂêØÊó†ÊïåÔºöÊó∂Èó¥Êó†Èôê ‚òÖ", CONFIG.DESIGN_W/2, CONFIG.DESIGN_H/2, "#0ff");
                e.target.value = '';
                e.target.blur();
                this.updateUI();
            }
        });
    }

    simulateLoading() {
        return new Promise(resolve => {
            const logs = ["Ê≠£Âú®Âä†ËΩΩÁâ©ÁêÜÂºïÊìé...", "Ê≠£Âú®ÁîüÊàêÊòüÁ≥ªÊï∞ÊçÆ...", "Ê≠£Âú®Ê†°ÂáÜÊøÄÂÖâÁâµÂºïÊùü...", "Á≥ªÁªüÂáÜÂ§áÂ∞±Áª™„ÄÇ"];
            let i = 0;
            const el = document.getElementById('loading-log');
            const interval = setInterval(() => {
                if (i < logs.length) {
                    el.innerText = logs[i++];
                } else {
                    clearInterval(interval);
                    document.getElementById('loading-layer').style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById('loading-layer').style.display = 'none';
                        resolve();
                    }, 500);
                }
            }, 800);
        });
    }

    resize() {
        const con = document.getElementById('game-container');
        const aspect = CONFIG.DESIGN_W / CONFIG.DESIGN_H;
        let w = con.clientWidth;
        let h = con.clientHeight;
        
        if (w / h > aspect) w = h * aspect;
        else h = w / aspect;
        
        this.canvas.width = w;
        this.canvas.height = h;
        this.scale = w / CONFIG.DESIGN_W;
        this.ctx.scale(this.scale, this.scale);
        
        if(this.bgStars.length === 0) this.initStars();
    }

    initStars() {
        this.bgStars = [];
        for(let i=0; i<120; i++) {
            this.bgStars.push({
                x: Math.random() * CONFIG.DESIGN_W,
                y: Math.random() * CONFIG.DESIGN_H,
                s: Math.random() * 2,
                a: Math.random(),
                speed: Math.random() * 0.2
            });
        }
    }

    initEvents() {
        window.addEventListener('keydown', e => {
            if(document.activeElement === document.getElementById('cheat-box')) return;
            if (this.state !== 'PLAYING') return;
            if (e.code === 'Space' || e.code === 'ArrowDown') this.actionShoot();
            if (e.code === 'ArrowUp') this.actionBomb();
        });
        const bind = (id, fn) => {
            const el = document.getElementById(id);
            el.addEventListener('mousedown', (e) => { e.preventDefault(); fn(); });
            el.addEventListener('touchstart', (e) => { e.preventDefault(); fn(); });
        };
        bind('btn-shoot', () => this.state === 'PLAYING' && this.actionShoot());
        bind('btn-bomb', () => this.state === 'PLAYING' && this.actionBomb());
        this.canvas.addEventListener('mousedown', () => this.state === 'PLAYING' && this.actionShoot());
        
        // --- Êñ∞Â¢ûÔºöÊâãÂä®ËøáÂÖ≥ÊåâÈíÆÁõëÂê¨ ---
        document.getElementById('warp-btn').addEventListener('click', () => {
            if(this.isGodMode && this.money >= this.target) {
                this.checkEnd(); // ÊâãÂä®Ëß¶ÂèëÁªìÁÆó
            }
        });
    }

    startLevel(lvl) {
        this.level = lvl;
        this.target = this.calcTarget(lvl);
        this.time = CONFIG.TIME_LIMIT;
        this.resetHook();
        this.generateItems(lvl);
        this.state = 'PLAYING';
        this.updateUI();
        this.saveData();
    }

    calcTarget(lvl) {
        return (this.money || 0) + 800 + (lvl * 600);
    }

    generateItems(lvl) {
        this.items = [];
        const count = 10 + Math.min(lvl * 2, 15);
        for(let i=0; i<count; i++) {
            let key;
            const r = Math.random();
            if (lvl >= 3 && r < 0.08) key = 'BLACK_HOLE';
            else if (lvl >= 2 && r < 0.15) key = 'UFO';
            else if (lvl >= 2 && r < 0.20) key = 'VOYAGER';
            else if (r < 0.25) key = 'BAG';
            else if (r < 0.30) key = 'CRYSTAL';
            else if (r < 0.45) key = 'JUPITER';
            else if (r < 0.60) key = 'SATURN';
            else if (r < 0.70) key = 'MINE';
            else if (lvl >= 4 && r < 0.75) key = 'SUN';
            else key = Math.random() > 0.5 ? 'ASTEROID_L' : 'ASTEROID_S';
            if (lvl === 1 && ['BLACK_HOLE', 'SUN', 'MINE'].includes(key)) key = 'MARS';
            const tmpl = CATALOG[key];
            this.spawnItem(tmpl);
        }
    }

    spawnItem(tmpl) {
        for(let k=0; k<100; k++) {
            const x = Math.random() * (CONFIG.DESIGN_W - 100) + 50;
            const y = Math.random() * (CONFIG.DESIGN_H - 250) + 200;
            let ok = true;
            for(let it of this.items) {
                const dist = Math.hypot(x - it.x, y - it.y);
                if (dist < tmpl.radius + it.radius + 15) { ok = false; break; }
            }
            if(ok) {
                const item = { 
                    ...tmpl, x, y, 
                    rot: Math.random()*6.28, 
                    active: true,
                    vx: tmpl.move ? (Math.random() > 0.5 ? tmpl.speed : -tmpl.speed) : 0
                };
                this.items.push(item);
                break;
            }
        }
    }

    loop(ts) {
        if(!this.lastT) this.lastT = ts;
        const dt = (ts - this.lastT) / 1000;
        this.lastT = ts;
        if (this.state === 'PLAYING') this.update(dt);
        this.draw();
        requestAnimationFrame(this.loop);
    }

    update(dt) {
        // Êó†ÊïåÊ®°Âºè‰∏çÂáèÊó∂Èó¥
        if (!this.isGodMode) {
            this.time -= dt;
            if(this.time <= 0) { this.time = 0; this.checkEnd(); }
        }
        
        const timeEl = document.getElementById('ui-time');
        if (this.isGodMode) {
            if (timeEl.innerText !== '‚àû') timeEl.innerText = '‚àû';
        } else {
            timeEl.innerText = Math.ceil(this.time);
        }

        const ox = CONFIG.DESIGN_W / 2;
        const oy = CONFIG.HOOK_ORIGIN_Y;

        if(this.hook.status === 0) {
            this.hook.angle += CONFIG.SWING_SPEED * this.hook.dir;
            if(Math.abs(this.hook.angle) > CONFIG.MAX_ANGLE) this.hook.dir *= -1;
        } else if(this.hook.status === 1) {
            this.hook.len += CONFIG.HOOK_SPEED_OUT;
            const rad = this.hook.angle * Math.PI / 180;
            this.hook.x = ox + Math.sin(rad) * this.hook.len;
            this.hook.y = oy + Math.cos(rad) * this.hook.len;
            if(this.hook.x<0 || this.hook.x>CONFIG.DESIGN_W || this.hook.y>CONFIG.DESIGN_H) {
                this.hook.status = 2;
            }
            for(let it of this.items) {
                if(!it.active) continue;
                if(Math.hypot(this.hook.x - it.x, this.hook.y - it.y) < it.radius + 5) {
                    if(it.type === 'mine') {
                        this.explode(it);
                        this.hook.status = 2;
                    } else {
                        this.hook.status = 2;
                        this.hook.item = it;
                        it.active = false;
                    }
                    break;
                }
            }
        } else if(this.hook.status === 2) {
            let speed = CONFIG.HOOK_SPEED_IN;
            if(this.hook.item) {
                speed = Math.max(1, CONFIG.HOOK_SPEED_IN / (this.hook.item.weight * 0.3));
            } else {
                speed *= 2;
            }
            this.hook.len -= speed;
            if(this.hook.len <= 40) {
                this.hook.len = 40;
                this.hook.status = 0;
                if(this.hook.item) {
                    this.collect(this.hook.item);
                    this.hook.item = null;
                }
            }
            const rad = this.hook.angle * Math.PI / 180;
            this.hook.x = ox + Math.sin(rad) * this.hook.len;
            this.hook.y = oy + Math.cos(rad) * this.hook.len;
        }

        this.items.forEach(it => {
            if(it.active && it.vx !== 0) {
                it.x += it.vx;
                if(it.x < it.radius || it.x > CONFIG.DESIGN_W - it.radius) it.vx *= -1;
            }
            if(it === this.hook.item) {
                it.x = this.hook.x;
                it.y = this.hook.y + it.radius * 0.5;
            }
        });

        for(let i=this.particles.length-1; i>=0; i--) {
            const p = this.particles[i];
            p.life--;
            p.x += p.vx; p.y += p.vy;
            if(p.life<=0) this.particles.splice(i,1);
        }
    }

    actionShoot() {
        if(this.hook.status === 0) this.hook.status = 1;
    }

    actionBomb() {
        if(this.bombs > 0 && this.hook.item) {
            this.bombs--;
            this.createExplosion(this.hook.item.x, this.hook.item.y, 20, '#f00');
            this.hook.item = null;
            this.updateUI();
        }
    }

    collect(item) {
        let val = item.val;
        let txt = `+${val}`;
        let col = '#fff';
        if(item.type === 'bag') {
            const r = Math.random();
            if(r < 0.4) { val = Math.floor(Math.random()*800)+200; txt=`$${val}`; col='#ffd700'; }
            else if(r < 0.7) { this.bombs++; val=0; txt="È±ºÈõ∑ +1"; col='#f00'; }
            else { val=10; txt="Â§™Á©∫ÂûÉÂúæ"; col='#888'; }
        }
        if(val > 0) this.money += val;
        this.showFloat(txt, CONFIG.DESIGN_W/2, 200, col);
        this.updateUI();
    }

    explode(center) {
        this.createExplosion(center.x, center.y, 50, '#ffaa00');
        center.active = false;
        this.items.forEach(it => {
            if(it.active && Math.hypot(it.x - center.x, it.y - center.y) < 150) {
                it.active = false;
                this.createExplosion(it.x, it.y, 10, '#aaa');
            }
        });
    }

    draw() {
        const ctx = this.ctx;
        ctx.clearRect(0, 0, CONFIG.DESIGN_W, CONFIG.DESIGN_H);
        this.bgStars.forEach(s => {
            s.a += (Math.random()-0.5)*0.05;
            if(s.a<0.2) s.a=0.2; if(s.a>1) s.a=1;
            ctx.fillStyle = `rgba(255,255,255,${s.a})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        });
        this.drawPlayer(CONFIG.DESIGN_W/2, CONFIG.HOOK_ORIGIN_Y - 30);
        const rad = this.hook.angle * Math.PI / 180;
        let hx = this.hook.x, hy = this.hook.y;
        if(this.hook.status === 0) {
            hx = CONFIG.DESIGN_W/2 + Math.sin(rad) * 40;
            hy = CONFIG.HOOK_ORIGIN_Y + Math.cos(rad) * 40;
        }
        ctx.shadowBlur = 10; ctx.shadowColor = '#0ff';
        ctx.strokeStyle = '#0ff'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(CONFIG.DESIGN_W/2, CONFIG.HOOK_ORIGIN_Y);
        ctx.lineTo(hx, hy); ctx.stroke();
        ctx.shadowBlur = 0;
        ctx.save();
        ctx.translate(hx, hy);
        ctx.rotate(rad);
        ctx.fillStyle = '#222'; ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#0ff'; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.moveTo(-6,-6); ctx.lineTo(-10,4); ctx.lineTo(-4,12); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(6,-6); ctx.lineTo(10,4); ctx.lineTo(4,12); ctx.stroke();
        ctx.restore();
        this.items.forEach(it => {
            if(it.active || it === this.hook.item) this.drawItem(it);
        });
        this.particles.forEach(p => {
            ctx.globalAlpha = p.life / 30;
            ctx.fillStyle = p.col;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.sz, 0, Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha = 1;
    }

    drawPlayer(x, y) {
        const ctx = this.ctx;
        ctx.save();
        ctx.translate(x, y);
        ctx.fillStyle = '#222'; ctx.beginPath();
        ctx.ellipse(0, 0, 35, 12, 0, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#0ff'; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(0, -6, 12, 0, Math.PI*2); ctx.fill();
        if(this.hook.status === 2) {
            ctx.fillStyle = '#f50'; ctx.beginPath();
            ctx.moveTo(-20, 5); ctx.lineTo(-25, 20+Math.random()*5); ctx.lineTo(-15, 5); ctx.fill();
            ctx.moveTo(20, 5); ctx.lineTo(25, 20+Math.random()*5); ctx.lineTo(15, 5); ctx.fill();
        }
        ctx.restore();
    }

    drawItem(it) {
        const ctx = this.ctx;
        const r = it.radius;
        ctx.save();
        ctx.translate(it.x, it.y);
        if(it !== this.hook.item && !it.move) ctx.rotate(it.rot); 
        if(it.type === 'blackhole') {
            const grd = ctx.createRadialGradient(0,0,r*0.2, 0,0,r);
            grd.addColorStop(0, '#000'); grd.addColorStop(0.5, '#000'); grd.addColorStop(1, '#500050');
            ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#a0a'; ctx.lineWidth=2; ctx.stroke();
            ctx.strokeStyle = 'rgba(255,0,255,0.5)';
            ctx.beginPath(); ctx.ellipse(0, 0, r*1.6, r*0.4, -0.5, 0, Math.PI*2); ctx.stroke();
        } else if(it.type === 'wormhole') {
            ctx.fillStyle = '#309'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.setLineDash([5,5]); ctx.beginPath(); ctx.arc(0,0,r-5,0,Math.PI*2); ctx.stroke();
            ctx.setLineDash([]);
        } else if(it.type === 'ufo') {
            ctx.fillStyle = '#888';
            ctx.beginPath(); ctx.ellipse(0, 5, r, r*0.4, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#0f0';
            ctx.beginPath(); ctx.arc(0, 0, r*0.5, 0, Math.PI, true); ctx.fill();
            if(Math.floor(Date.now()/200)%2===0) {
                ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(-r*0.6, 5, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(r*0.6, 5, 3, 0, Math.PI*2); ctx.fill();
            }
        } else if(it.type === 'ship') {
            ctx.rotate(it.vx > 0 ? 0 : Math.PI);
            ctx.fillStyle = '#ccc';
            ctx.beginPath(); ctx.moveTo(r, 0); ctx.lineTo(-r, -r/2); ctx.lineTo(-r, r/2); ctx.fill();
            ctx.fillStyle = '#0ff'; ctx.fillRect(-r, -3, 5, 6);
        } else if(it.type === 'station') {
            ctx.fillStyle = '#555'; ctx.fillRect(-r, -r/4, r*2, r/2);
            ctx.fillStyle = '#aaa'; ctx.fillRect(-r/4, -r, r/2, r*2);
            ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill();
        } else if(it.type === 'planet' || it.type === 'star' || it.type === 'planet_land' || it.type === 'planet_band') {
            const grd = ctx.createRadialGradient(-r*0.3,-r*0.3,0, 0,0,r);
            grd.addColorStop(0, it.color[0]); grd.addColorStop(1, it.color[1]);
            if(it.type === 'star') { ctx.shadowBlur = 30; ctx.shadowColor = it.color[0]; }
            ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
            if(it.type === 'planet_land') {
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath(); ctx.arc(-5,-5, r*0.4, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(8,8, r*0.3, 0, Math.PI*2); ctx.fill();
            }
            if(it.type === 'planet_band') {
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(-r, -5, r*2, 10);
            }
        } else if(it.type === 'saturn') {
            const grd = ctx.createRadialGradient(0,0,0,0,0,r);
            grd.addColorStop(0, it.color[0]); grd.addColorStop(1, it.color[1]);
            ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle = 'rgba(200,200,200,0.6)'; ctx.lineWidth = 6;
            ctx.beginPath(); ctx.ellipse(0,0,r*1.8, r*0.6, -0.3, 0, Math.PI*2); ctx.stroke();
        } else if(it.type === 'rock') {
            ctx.fillStyle = it.color[0];
            ctx.beginPath();
            for(let i=0; i<7; i++) {
                const a = i/7 * Math.PI*2;
                const d = r * (0.8 + Math.random()*0.3);
                ctx.lineTo(Math.cos(a)*d, Math.sin(a)*d);
            }
            ctx.fill();
        } else if(it.type === 'bag') {
            ctx.fillStyle = '#808'; ctx.beginPath();
            ctx.roundRect(-12, -15, 24, 30, 8); ctx.fill();
            ctx.strokeStyle = '#f0f'; ctx.lineWidth=2; ctx.stroke();
            ctx.fillStyle = '#fff'; ctx.font='bold 16px Arial'; 
            ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('?',0,2);
        } else if(it.type === 'mine') {
            ctx.fillStyle = '#400'; ctx.beginPath(); ctx.arc(0,0,r*0.7,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = '#f00'; 
            for(let i=0; i<8; i++) {
                ctx.rotate(Math.PI/4); ctx.fillRect(r*0.6, -2, 6, 4);
            }
        } else if(it.type === 'crystal') {
            ctx.fillStyle = '#0ff'; ctx.beginPath(); 
            ctx.moveTo(0,-r); ctx.lineTo(r,0); ctx.lineTo(0,r); ctx.lineTo(-r,0); ctx.fill();
            ctx.fillStyle='rgba(255,255,255,0.6)'; ctx.beginPath(); ctx.moveTo(0,-r); ctx.lineTo(5,0); ctx.lineTo(0,r); ctx.fill();
        }
        ctx.restore();
        if(it.name && it !== this.hook.item && it.active) {
            ctx.fillStyle = 'rgba(0, 255, 255, 0.7)';
            ctx.font = '12px "Microsoft YaHei"';
            ctx.textAlign = 'center';
            ctx.fillText(it.name, it.x, it.y + it.radius + 15);
        }
    }

    createExplosion(x, y, n, col) {
        for(let i=0; i<n; i++) {
            this.particles.push({
                x, y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                life: 30+Math.random()*20, sz: Math.random()*4+1, col: col
            });
        }
    }

    showFloat(text, x, y, col) {
        const d = document.createElement('div');
        d.className = 'float-text'; d.innerText = text;
        d.style.color = col;
        d.style.left = (this.canvas.offsetLeft + x*this.scale) + 'px';
        d.style.top = (this.canvas.offsetTop + y*this.scale) + 'px';
        document.body.appendChild(d);
        setTimeout(()=>d.remove(), 1200);
    }

    checkEnd() {
        this.state = 'MENU';
        // ÈöêËóèË∑≥Ë∑ÉÊåâÈíÆ
        document.getElementById('warp-btn').style.display = 'none';

        if(this.money >= this.target) {
            this.showModal('‰ªªÂä°ÂÆåÊàê', 
                `Áä∂ÊÄÅÔºöÊàêÂäü<br>ËÉΩÈáèÔºö<span style="color:#ffd700">${this.money}</span> / ${this.target}`,
                '‰∏ã‰∏ÄÊòüÂå∫', () => this.startLevel(this.level+1));
        } else {
            this.showModal('‰ªªÂä°Â§±Ë¥•', 
                `Áä∂ÊÄÅÔºöËÉΩÈáè‰∏çË∂≥<br>ÁõÆÊ†áÔºö${this.target}`,
                'ÈáçÂêØÁ≥ªÁªü', () => this.resetGame());
        }
    }

    showModal(title, content, btnText, callback) {
        const overlay = document.getElementById('modal-overlay');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-content').innerHTML = content;
        const btn = document.getElementById('modal-btn');
        btn.innerText = btnText;
        btn.onclick = () => {
            overlay.style.display = 'none';
            callback();
        };
        overlay.style.display = 'flex';
    }

    updateUI() {
        document.getElementById('ui-money').innerText = this.money;
        document.getElementById('ui-target').innerText = this.target;
        document.getElementById('ui-level').innerText = this.level;
        document.getElementById('ui-bomb').innerText = this.bombs;
        
        if(this.isGodMode) {
            document.getElementById('ui-time').innerText = "‚àû";
            // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÁõÆÊ†á‰ª•ÊòæÁ§∫ËøáÂÖ≥ÊåâÈíÆ
            const warpBtn = document.getElementById('warp-btn');
            if (this.money >= this.target) {
                warpBtn.style.display = 'block';
            } else {
                warpBtn.style.display = 'none';
            }
        } else {
            document.getElementById('warp-btn').style.display = 'none';
        }
    }

    resetHook() {
        this.hook.status = 0; this.hook.len = 40; this.hook.angle = 0; this.hook.item = null;
    }

    resetGame() {
        localStorage.clear();
        this.level=1; this.money=0; this.bombs=0;
        this.startLevel(1);
    }

    saveData() {
        localStorage.setItem('cm_save', JSON.stringify({ l:this.level, m:this.money, b:this.bombs }));
    }
    loadSave() {
        try {
            const d = JSON.parse(localStorage.getItem('cm_save'));
            if(d) { this.level=d.l; this.money=d.m; this.bombs=d.b||0; }
        } catch(e){}
    }
}

window.onload = () => new Game();
</script>
</body>
</html>
